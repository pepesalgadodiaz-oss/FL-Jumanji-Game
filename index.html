<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jumanji FL ‚Äì Interactivo (v2)</title>
<style>
:root{ --do:#e53935; --crime:#1e88e5; --cyber:#f57c00; --rc:#8e24aa; --inter:#ef4444; --azar:#fdd835; --bg:#0f172a; --panel:#111826; --text:#e5e7eb; --muted:#9ca3af; --ok:#10b981; --err:#ef4444; --btn:#2563eb;}
*{box-sizing:border-box} body{margin:0;background:linear-gradient(135deg,#0b1221,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
.wrapper{max-width:1200px;margin:24px auto;padding:16px} h1{margin:0 0 6px} .sub{color:var(--muted);margin-bottom:16px}
.panel{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{background:var(--btn);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
input,select{background:#0b1221;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px 10px;border-radius:8px}
.badge{display:inline-flex;gap:6px;align-items:center;background:#1f2937;color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}
.dot{width:12px;height:12px;border-radius:50%}
.grid{display:grid;grid-template-columns:repeat(26,1fr);gap:6px;padding:12px}
.trackTitle{grid-column:1/-1;color:var(--muted);font-weight:800;margin:6px 0}
.cell{aspect-ratio:1/1;border-radius:10px;border:1px solid rgba(255,255,255,.08);display:flex;justify-content:center;align-items:center;position:relative;font-weight:700;font-size:12px}
.cell small{opacity:.85}
.cell.do{background:linear-gradient(180deg,rgba(229,57,53,.22),rgba(229,57,53,.08))}
.cell.crime{background:linear-gradient(180deg,rgba(30,136,229,.22),rgba(30,136,229,.08))}
.cell.cyber{background:linear-gradient(180deg,rgba(245,124,0,.22),rgba(245,124,0,.08))}
.cell.rc{background:linear-gradient(180deg,rgba(142,36,170,.22),rgba(142,36,170,.08))}
.cell.case{outline:2px solid rgba(255,255,255,.14)}
.cell.azar{outline:2px dashed var(--azar)}
.cell.inter{outline:2px dashed var(--inter)}
.cell.preview{box-shadow:inset 0 0 0 3px rgba(255,255,255,.35)}
.token{position:absolute;bottom:4px;right:4px;width:18px;height:18px;border-radius:50%;border:2px solid rgba(0,0,0,.35)}
.tA{background:#22c55e}.tB{background:#60a5fa}.tC{background:#f59e0b}.tD{background:#ef4444}
hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0}
.small{color:var(--muted);font-size:12px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);padding:16px;z-index:50}
.modalInner{width:min(840px,96vw);background:var(--panel);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
.qHeader{display:flex;justify-content:space-between;align-items:center}
.opts{display:grid;gap:8px;margin:10px 0}
.optBtn{background:#1f2937;border:1px solid rgba(255,255,255,.1);padding:10px;border-radius:10px;text-align:left}
.optBtn.correct{outline:2px solid var(--ok)} .optBtn.wrong{outline:2px solid var(--err)}
.timer{background:#1f2937;color:#fff;padding:6px 10px;border-radius:999px;font-variant-numeric:tabular-nums}
.feedback{color:var(--muted);margin-top:4px}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.brand .tag{background:#1f2937;padding:4px 8px;border-radius:8px;font-size:12px;color:#9ca3af}
</style>
</head>
<body>
<div class="wrapper">
  <div class="brand">
    <h1>Jumanji FL ¬∑ Interactivo</h1>
    <span class="tag">Zurich ¬∑ Demo</span>
  </div>
  <div class="sub">4 caminos ¬∑ D&O ¬∑ Crime ¬∑ Cyber ¬∑ RC Profesional ¬∑ con casos, azar e intersecciones.</div>
  <div class="panel">
    <div class="row">
      <button id="btnRoll">üé≤ Tirar dado</button>
      <span class="badge">N√∫mero: <strong id="rollNum">-</strong></span>
      <button id="btnOpenQ" disabled>üìú Abrir pregunta</button>
      <button id="btnResolve" disabled>‚úÖ Aplicar resultado</button>
      <button id="btnNext" disabled>‚û°Ô∏è Terminar turno</button>
      <button id="btnExport">‚¨áÔ∏è Exportar CSV</button>
      <span class="small">Turno de: <b id="turnTeam">Equipo A</b></span>
    </div>
    <div class="row" style="margin-top:10px">
      <label>Timer (s) <input id="inTimer" type="number" value="45" min="10" max="120" style="width:80px"></label>
      <label>Equipo A <input id="nameA" value="Equipo A" style="width:140px"></label>
      <label>Equipo B <input id="nameB" value="Equipo B" style="width:140px"></label>
      <label>Equipo C <input id="nameC" value="Equipo C" style="width:140px"></label>
      <label>Equipo D <input id="nameD" value="Equipo D" style="width:140px"></label>
      <button id="btnApplyNames">Aplicar nombres</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="badge"><span class="dot" style="background:#22c55e"></span><b id="bA">Equipo A</b>: <span id="scA">0</span></span>
      <span class="badge"><span class="dot" style="background:#60a5fa"></span><b id="bB">Equipo B</b>: <span id="scB">0</span></span>
      <span class="badge"><span class="dot" style="background:#f59e0b"></span><b id="bC">Equipo C</b>: <span id="scC">0</span></span>
      <span class="badge"><span class="dot" style="background:#ef4444"></span><b id="bD">Equipo D</b>: <span id="scD">0</span></span>
      <span class="small">Posiciones (por camino actual): A:<span id="posA">1</span> B:<span id="posB">1</span> C:<span id="posC">1</span> D:<span id="posD">1</span></span>
    </div>
  </div>
  <div class="panel row" style="margin-top:12px">
    <span class="badge"><span class="dot" style="background:var(--do)"></span>D&O</span>
    <span class="badge"><span class="dot" style="background:var(--crime)"></span>Crime</span>
    <span class="badge"><span class="dot" style="background:var(--cyber)"></span>Cyber</span>
    <span class="badge"><span class="dot" style="background:var(--rc)"></span>RC Profesional</span>
    <span class="badge"><span class="dot" style="background:var(--inter)"></span>Intersecci√≥n</span>
    <span class="badge"><span class="dot" style="background:var(--azar)"></span>Azar</span>
    <span class="small">Casos en 3 y 12 ¬∑ Azar en 5, 14, 22 ¬∑ Intersecciones en 9, 17, 23</span>
  </div>
  <div id="board" class="panel grid"></div>
</div>
<div id="modal" class="modal">
  <div class="modalInner">
    <div class="qHeader">
      <h3 id="qTitle">Pregunta</h3>
      <div class="row">
        <span class="badge">Responder por: <select id="selProd"></select></span>
        <span class="timer" id="timer">--</span>
        <button id="closeModal">Cerrar</button>
      </div>
    </div>
    <div class="small" id="qMeta"></div>
    <hr/>
    <div id="qText"></div>
    <div class="opts">
      <button class="optBtn" id="optA"></button>
      <button class="optBtn" id="optB"></button>
      <button class="optBtn" id="optC"></button>
    </div>
    <div class="feedback" id="qFb"></div>
    <div class="small" id="postRule"></div>
  </div>
</div>
<script>
const mk=(Producto,Categoria,Pregunta,A,B,C,Resp,Fb)=>({Producto,Categoria,Pregunta,A,B,C,Resp,Fb});
const bank=[
  mk("D&O","Conceptual","¬øCu√°l es el objetivo principal de una p√≥liza de D&O?","Proteger bienes personales y de la empresa por reclamos","Cubrir da√±os materiales","Asegurar veh√≠culos corporativos","A","Protege a directores/funcionarios ante p√©rdidas financieras por actos incorrectos."),
  mk("D&O","Conceptual","¬øQui√©nes pueden presentar reclamaciones en D&O?","Solo empleados","Empleados, accionistas, reguladores, clientes, proveedores, competidores; incluso la propia compa√±√≠a","Solo accionistas","B","El espectro de reclamantes es amplio."),
  mk("D&O","Conceptual","¬øQu√© tipo de p√©rdidas cubre D&O?","P√©rdidas financieras por reclamos","Da√±os a oficinas","Gastos m√©dicos","A","Cubre p√©rdidas financieras derivadas de actos incorrectos."),
  mk("D&O","Conceptual","Ejemplo de cobertura ligada a insolvencia","Honorarios para comparecer en audiencia de concurso mercantil","Pago de dividendos","Compra de acciones","A","Gastos legales para audiencias de insolvencia."),
  mk("D&O","Conceptual","Rango t√≠pico de sumas aseguradas en Zurich para D&O","USD 100k‚Äì500k","USD 1M‚Äì15M","USD 10M‚Äì50M","B","Capacidad local neta de USD 1M a 15M."),
  mk("D&O","Conceptual","¬øQu√© es Mitigaci√≥n de P√©rdidas en D&O?","Gastos para remediar/prevenir una p√©rdida tras descubrir un acto incorrecto","Cobertura m√©dica","Descuento de prima","A","Permite actuar para evitar que la p√©rdida se agrave."),
  mk("D&O","Conceptual","Documento clave para cotizar D&O","Acta constitutiva","Estados financieros auditados del √∫ltimo a√±o","Contratos laborales","B","EF auditados + cuestionario firmado son requisitos usuales."),
  mk("D&O","Conceptual","¬øIncluye pr√°cticas laborales indebidas (EPL)?","S√≠","No","Solo si es colectiva","A","EPL puede estar contemplado seg√∫n condiciones."),
  mk("D&O","Conceptual","¬øQu√© es un acto incorrecto en D&O?","Error, omisi√≥n, declaraci√≥n falsa o negligencia en funciones directivas","Da√±o f√≠sico a terceros","Robo de propiedad","A","Definici√≥n est√°ndar en p√≥lizas D&O."),
  mk("D&O","Conceptual","¬øPuede incluir coberturas para filiales extranjeras?","S√≠, con condiciones y declaraci√≥n","No, solo M√©xico","Solo si tienen m√°s de 50 empleados","A","Puede ampliarse cobertura internacional seg√∫n condiciones."),
  mk("D&O","Mini-escenario","Un director aprueba inversi√≥n riesgosa que genera p√©rdidas; accionistas demandan.","Cubre defensa y posibles indemnizaciones","No cubre nada","Solo cubre si hubo asesor√≠a externa","A","Cubierto como acto incorrecto salvo exclusiones aplicables."),
  mk("D&O","Mini-escenario","Un funcionario es investigado por regulador sin demanda formal.","No cubre","Cubre gastos de defensa para investigaciones formales","Solo cubre si hay demanda judicial","B","Cobertura de investigaciones formales puede aplicar."),
  mk("D&O","Mini-escenario","Reclamaci√≥n contra exdirector por actos durante su gesti√≥n.","No cubre","Solo cubre si a√∫n es empleado","Cubre actos ocurridos durante su periodo","C","Retroactividad aplica mientras el acto haya ocurrido en vigencia."),
  mk("D&O","Caso","CASO: Ocultamiento de info relevante previo a emisi√≥n de acciones; inversionistas demandan.","Cubre todo","No cubre por dolo probado","Cubre gastos de defensa hasta aclarar dolo","C","Defensa cubierta mientras no haya sentencia firme por dolo."),
  mk("D&O","Caso","CASO: Director aprueba pago de dividendos ilegales; empresa entra en insolvencia.","Cubre defensa y posible indemnizaci√≥n","No cubre por acto ilegal probado","Solo cubre si se devuelve el dinero","A","Cubierto mientras no exista sentencia firme que confirme ilegalidad."),
  mk("Crime","Conceptual","¬øQu√© protege una p√≥liza de Crime?","P√©rdidas por fraude, robo o actos deshonestos","Da√±os a propiedad por incendio","P√©rdidas por fluctuaciones cambiarias","A","Cubre p√©rdidas financieras por delitos internos o externos."),
  mk("Crime","Conceptual","¬øQu√© es un delito interno?","Robo por proveedores","Fraude cometido por empleados (con o sin colusi√≥n)","Hurto por clientes","B","Delito interno involucra a empleados."),
  mk("Crime","Conceptual","¬øQu√© es un delito externo?","Fraude por empleados","Robo por terceros ajenos","Da√±os materiales","B","Delito externo lo cometen personas ajenas a la empresa."),
  mk("Crime","Conceptual","¬øSe cubren transferencias electr√≥nicas fraudulentas?","S√≠, si son resultado de fraude cubierto","No, nunca","Solo si hay p√≥liza de Cyber","A","Cubierto si deriva de fraude y se cumplen condiciones de la p√≥liza."),
  mk("Crime","Conceptual","Suma asegurada t√≠pica local en Zurich para Crime","USD 50k‚Äì500k","USD 1M‚Äì5M","USD 10M‚Äì20M","B","Capacidad local suele estar en ese rango."),
  mk("Crime","Conceptual","¬øCubre p√©rdidas descubiertas despu√©s de la vigencia?","S√≠, si ocurri√≥ en vigencia y est√° dentro del periodo descubrimiento","No","Solo con endoso especial","A","Aplica si se descubren en periodo de descubrimiento."),
  mk("Crime","Conceptual","¬øQu√© exclusi√≥n es t√≠pica en Crime?","Da√±os por incendio","Actos cometidos por socios o due√±os con control","Robo de mercanc√≠as","B","Fraudes cometidos por due√±os/accionistas con control no suelen estar cubiertos."),
  mk("Crime","Conceptual","¬øCubre falsificaci√≥n de cheques?","S√≠","No","Solo con endoso","A","Puede cubrir falsificaci√≥n de documentos financieros."),
  mk("Crime","Conceptual","Documento clave para cotizar Crime","Estados financieros auditados","Licencia de construcci√≥n","P√≥liza de transporte","A","EF auditados y cuestionario ayudan a evaluar riesgo."),
  mk("Crime","Conceptual","¬øQu√© es colusi√≥n en Crime?","Acuerdo il√≠cito entre empleados para cometer fraude","Contrato legal de trabajo","Asociaci√≥n de empresas","A","Implica cooperaci√≥n entre partes para cometer un delito."),
  mk("Crime","Mini-escenario","Cajero retira dinero de caja y lo deposita en cuenta personal.","Delito interno cubierto","No cubierto","Solo cubierto si hay video","A","Robo por empleado cubierto como delito interno."),
  mk("Crime","Mini-escenario","Proveedor factura bienes que nunca entrega y el pago es autorizado por un empleado.","Delito externo cubierto","No cubierto","Solo cubierto si hay seguro de transporte","A","Fraude externo con posible colusi√≥n interna."),
  mk("Crime","Mini-escenario","Descubren fraude contable 4 meses despu√©s de terminar la p√≥liza.","Cubierto si dentro del periodo descubrimiento","No cubierto","Solo si hay Cyber","A","Aplica si est√° dentro del periodo de descubrimiento."),
  mk("Crime","Caso","CASO: Un empleado manipula transferencias electr√≥nicas para desviar fondos.","Cubre p√©rdidas y gastos legales","No cubre nada","Solo cubre si hay Cyber","A","Fraude interno por manipulaci√≥n de transferencias est√° cubierto."),
  mk("Crime","Caso","CASO: Tercero roba mercanc√≠a de almac√©n sin participaci√≥n de empleados.","Cubierto como delito externo","No cubre","Solo cubierto si hay CCTV","A","Robo por tercero externo es delito externo cubierto."),
  mk("Cyber","Conceptual","¬øQu√© protege una p√≥liza de Cyber?","P√©rdidas financieras, costos de respuesta y responsabilidad por incidentes cibern√©ticos","Solo da√±os a hardware","√önicamente virus inform√°ticos","A","Cobertura integral de incidentes cibern√©ticos, internos y externos."),
  mk("Cyber","Conceptual","¬øCubre ransomware?","S√≠, incluyendo pago de rescate seg√∫n condiciones","No","Solo si hay antivirus instalado","A","Cubre gastos de rescate y restauraci√≥n de datos."),
  mk("Cyber","Conceptual","¬øIncluye gastos de notificaci√≥n a afectados por brecha de datos?","S√≠","No","Solo con endoso","A","Obligatorio en muchas jurisdicciones, cubierto por p√≥liza."),
  mk("Cyber","Conceptual","¬øQu√© es ingenier√≠a social?","T√©cnica de manipulaci√≥n para obtener informaci√≥n o acceso","Da√±o f√≠sico a servidores","Dise√±o de redes","A","Ataque basado en manipulaci√≥n psicol√≥gica."),
  mk("Cyber","Conceptual","¬øCubre interrupci√≥n del negocio por ataque?","S√≠, p√©rdida de ingresos y gastos extra","No","Solo si dura m√°s de 72 horas","A","Cobertura de business interruption por incidentes cibern√©ticos."),
  mk("Cyber","Conceptual","Suma asegurada t√≠pica local en Zurich para Cyber","USD 50k‚Äì200k","USD 500k‚Äì5M","USD 10M‚Äì20M","B","Capacidad local suele estar en ese rango."),
  mk("Cyber","Conceptual","¬øCubre multas y sanciones regulatorias?","S√≠, en ciertos casos","No","Solo en USA","A","Puede cubrir sanciones por violaci√≥n de leyes de privacidad."),
  mk("Cyber","Conceptual","Exclusi√≥n t√≠pica en Cyber","Actos dolosos del asegurado","Phishing","Interrupci√≥n del negocio","A","Actos dolosos propios no son cubiertos."),
  mk("Cyber","Conceptual","¬øIncluye gastos de expertos forenses?","S√≠","No","Solo con autorizaci√≥n judicial","A","Forenses ayudan a identificar y contener incidentes."),
  mk("Cyber","Conceptual","¬øQu√© es un ataque DDoS?","Sobrecarga de servidores para interrumpir servicios","Robo de identidad","Da√±o f√≠sico a hardware","A","Denial of Service Distribuido, interrumpe operaciones."),
  mk("Cyber","Mini-escenario","Ataque de ransomware cifra todos los archivos; piden pago en criptomonedas.","Cubierto como extorsi√≥n cibern√©tica","No cubierto","Solo si se recuperan backups","A","Cubre negociaci√≥n y pago bajo condiciones."),
  mk("Cyber","Mini-escenario","Brecha de datos expone informaci√≥n de clientes.","Cubre notificaci√≥n y monitoreo de identidad","No cubre","Solo cubre si hay p√≥liza de RC","A","Gastos de notificaci√≥n, PR y monitoreo cubiertos."),
  mk("Cyber","Mini-escenario","Phishing logra transferencia no autorizada.","Cubierto si es por ingenier√≠a social","No cubre","Solo si hay Crime","A","Ingenier√≠a social cubierta si est√° contemplada."),
  mk("Cyber","Caso","CASO: Cliente demanda por p√©rdida de datos cr√≠ticos tras ataque.","Cubierto como responsabilidad civil","No cubierto","Solo cuberto si hay contrato","A","Cubre responsabilidad frente a terceros."),
  mk("Cyber","Caso","CASO: Ciberataque detiene operaciones 5 d√≠as, generando p√©rdidas millonarias.","Cubierto como interrupci√≥n de negocio","No cubierto","Solo si dura m√°s de 7 d√≠as","A","Cubre ingresos perdidos y gastos adicionales."),
  mk("RC Profesional","Conceptual","¬øQu√© protege una p√≥liza de RC Profesional?","Responsabilidad por errores, omisiones o negligencia en servicios profesionales","Da√±os a oficinas","Robo de bienes","A","Cubre responsabilidad derivada de la prestaci√≥n de servicios profesionales."),
  mk("RC Profesional","Conceptual","¬øCubre da√±os a bienes del cliente bajo custodia del asegurado?","S√≠, si es consecuencia de un error profesional","No","Solo si hay endoso de propiedad","A","Puede cubrir da√±os relacionados con la actividad profesional."),
  mk("RC Profesional","Conceptual","Exclusi√≥n t√≠pica en RC Profesional","Actos dolosos","Errores administrativos","Publicidad","A","Actos dolosos del asegurado no son cubiertos."),
  mk("RC Profesional","Conceptual","¬øCubre reclamaciones por difamaci√≥n?","S√≠, si es en el contexto profesional","No","Solo en medios","A","Difamaci√≥n y calumnia cubiertas si ocurren en el ejercicio profesional."),
  mk("RC Profesional","Conceptual","Documento clave para cotizar RC Profesional","Contratos de prestaci√≥n de servicios","Acta constitutiva","Estados financieros","A","Contratos definen el alcance y riesgo del servicio."),
  mk("RC Profesional","Conceptual","Suma asegurada t√≠pica local en Zurich para RC Profesional","USD 50k‚Äì500k","USD 1M‚Äì5M","USD 10M‚Äì20M","B","Capacidad local suele estar en ese rango."),
  mk("RC Profesional","Conceptual","¬øCubre subcontratistas?","S√≠, si est√°n declarados y aceptados","No","Solo si son empleados","A","Cobertura se extiende si se declaran en la p√≥liza."),
  mk("RC Profesional","Conceptual","¬øQu√© es una reclamaci√≥n ‚Äúhecha y reportada‚Äù?","Reclamo hecho y notificado a la aseguradora durante la vigencia","Reclamo hecho antes de la p√≥liza","Reclamo reportado despu√©s de 5 a√±os","A","Cl√°usula t√≠pica en p√≥lizas de RC Profesional."),
  mk("RC Profesional","Conceptual","¬øCubre trabajos realizados antes de la vigencia?","S√≠, si hay retroactividad declarada","No","Solo si es menos de 1 a√±o antes","A","Retroactividad declarada cubre actos anteriores."),
  mk("RC Profesional","Conceptual","Exclusi√≥n t√≠pica de profesiones","M√©dicos y arquitectos","Consultores de TI","Contadores","A","Algunas p√≥lizas excluyen profesiones de alto riesgo."),
  mk("RC Profesional","Mini-escenario","Consultor entrega informe con errores graves que afectan al cliente.","Cubierto como error profesional","No cubierto","Solo cubierto si hay contrato","A","Error profesional cubierto por la p√≥liza."),
  mk("RC Profesional","Mini-escenario","Dise√±ador omite incluir requisitos legales en un proyecto.","Cubierto como omisi√≥n","No cubierto","Solo cubierto si hay endoso","A","Omisi√≥n profesional cubierta si hay p√©rdida derivada."),
  mk("RC Profesional","Mini-escenario","Contador presenta declaraciones con errores que generan multas.","Cubierto como negligencia profesional","No cubierto","Solo si hay seguro de fianzas","A","Negligencia cubierta si causa p√©rdidas al cliente."),
  mk("RC Profesional","Caso","CASO: Abogado redacta contrato con cl√°usulas inv√°lidas, generando litigio costoso.","Cubierto como error profesional","No cubierto","Solo si es penal","A","Error de redacci√≥n cubierto bajo la p√≥liza."),
  mk("RC Profesional","Caso","CASO: Ingeniero de seguridad omite pruebas cr√≠ticas, causando accidente.","Cubierto como negligencia profesional","No cubierto","Solo si hay seguro de responsabilidad civil general","A","Omisi√≥n cubierta si deriva de su actividad profesional.")
];
const byProduct={"D&O":bank.filter(q=>q.Producto==="D&O"),"Crime":bank.filter(q=>q.Producto==="Crime"),"Cyber":bank.filter(q=>q.Producto==="Cyber"),"RC Profesional":bank.filter(q=>q.Producto==="RC Profesional")};
const cur={"D&O":0,"Crime":0,"Cyber":0,"RC Profesional":0};
const nextQ=(prod,allowCase=true)=>{const pool=allowCase?byProduct[prod]:byProduct[prod].filter(x=>x.Categoria!=="Caso");const arr=pool.length?pool:byProduct[prod];const q=arr[cur[prod]%arr.length];cur[prod]++;return q;};

const tracks=[{name:"D&O",key:"do"},{name:"Crime",key:"crime"},{name:"Cyber",key:"cyber"},{name:"RC Profesional",key:"rc"}];
const CASE_SLOTS=[3,12], AZAR_SLOTS=[5,14,22], INTER_SLOTS=[9,17,23];
const interPairs={"D&O":{9:"Crime",17:"Cyber",23:"RC Profesional"},"Crime":{9:"D&O",17:"Cyber",23:"RC Profesional"},"Cyber":{9:"D&O",17:"Crime",23:"RC Profesional"},"RC Profesional":{9:"D&O",17:"Crime",23:"Cyber"}};

const board=document.getElementById('board');
tracks.forEach(tr=>{const t=document.createElement('div');t.className='trackTitle';t.textContent=`Camino ${tr.name}`;board.appendChild(t);
  for(let i=1;i<=25;i++){const c=document.createElement('div');c.className=`cell ${tr.key}`;c.dataset.track=tr.name;c.dataset.idx=i;
    if(CASE_SLOTS.includes(i)) c.classList.add('case'); if(AZAR_SLOTS.includes(i)) c.classList.add('azar'); if(INTER_SLOTS.includes(i)) c.classList.add('inter');
    c.innerHTML=`<small>${i}</small>`; board.appendChild(c);}});

const teams=[
  {name:"Equipo A", token:"tA", score:0, current:"D&O", pos:{"D&O":1,"Crime":1,"Cyber":1,"RC Profesional":1}, skip:false},
  {name:"Equipo B", token:"tB", score:0, current:"Crime", pos:{"D&O":1,"Crime":1,"Cyber":1,"RC Profesional":1}, skip:false},
  {name:"Equipo C", token:"tC", score:0, current:"Cyber", pos:{"D&O":1,"Crime":1,"Cyber":1,"RC Profesional":1}, skip:false},
  {name:"Equipo D", token:"tD", score:0, current:"RC Profesional", pos:{"D&O":1,"Crime":1,"Cyber":1,"RC Profesional":1}, skip:false}
];
let turn=0,lastRoll=null,previewCell=null,awaiting=false,timerId=null,leftToMove=0,chosenProduct=null;
const rollNum=document.getElementById('rollNum'),turnTeam=document.getElementById('turnTeam');
const posA=document.getElementById('posA'),posB=document.getElementById('posB'),posC=document.getElementById('posC'),posD=document.getElementById('posD');
const scA=document.getElementById('scA'),scB=document.getElementById('scB'),scC=document.getElementById('scC'),scD=document.getElementById('scD');

function renderTokens(){
  document.querySelectorAll('.token').forEach(t=>t.remove());
  teams.forEach(tm=>{const cell=document.querySelector(`.cell[data-track="${tm.current}"][data-idx="${tm.pos[tm.current]}"]`);
    if(cell){const tok=document.createElement('div');tok.className=`token ${tm.token}`;cell.appendChild(tok);} });
  posA.textContent=teams[0].pos[teams[0].current];posB.textContent=teams[1].pos[teams[1].current];
  posC.textContent=teams[2].pos[teams[2].current];posD.textContent=teams[3].pos[teams[3].current];
  scA.textContent=teams[0].score;scB.textContent=teams[1].score;scC.textContent=teams[2].score;scD.textContent=teams[3].score;
  turnTeam.textContent=teams[turn].name;
}
renderTokens();

function highlightPreview(){
  if(previewCell) previewCell.classList.remove('preview');
  const tm=teams[turn],track=tm.current,pos=tm.pos[track];
  const target=Math.min(25,pos+leftToMove);
  const cell=document.querySelector(`.cell[data-track="${track}"][data-idx="${target}"]`);
  if(cell){cell.classList.add('preview');previewCell=cell;}
}

document.getElementById('btnRoll').onclick=()=>{
  if(awaiting) return;
  lastRoll=Math.floor(Math.random()*6)+1; rollNum.textContent=lastRoll;
  leftToMove=lastRoll; highlightPreview();
  document.getElementById('btnOpenQ').disabled=false; awaiting=true;
};

document.getElementById('btnNext').onclick=()=>{
  turn=(turn+1)%teams.length;
  if(teams[turn].skip){ alert(`${teams[turn].name} pierde su turno por penalizaci√≥n.`); teams[turn].skip=false; turn=(turn+1)%teams.length; }
  lastRoll=null; rollNum.textContent='-'; awaiting=false; document.getElementById('btnOpenQ').disabled=true; document.getElementById('btnResolve').disabled=true;
  if(previewCell){previewCell.classList.remove('preview'); previewCell=null;}
  renderTokens();
};

const modal=document.getElementById('modal'),timerEl=document.getElementById('timer');
const qTitle=document.getElementById('qTitle'),qMeta=document.getElementById('qMeta'),qText=document.getElementById('qText'),qFb=document.getElementById('qFb');
const optA=document.getElementById('optA'),optB=document.getElementById('optB'),optC=document.getElementById('optC');
const selProd=document.getElementById('selProd'),postRule=document.getElementById('postRule');
document.getElementById('closeModal').onclick=()=>modal.style.display='none';
let currentQ=null,currentKind='Pregunta',answeredOK=null;

const flashPool=[
  {Producto:"D&O", Pregunta:"Flash D&O: menciona una exclusi√≥n t√≠pica.", A:"Correcto",B:"Incorrecto",C:"Paso",Resp:"A",Fb:"Acierto:+2 | Error:-1"},
  {Producto:"Crime", Pregunta:"Flash Crime: ¬øsuma asegurada m√°xima local usual?", A:"Correcto",B:"Incorrecto",C:"Paso",Resp:"A",Fb:"Acierto:+2 | Error:-1"},
  {Producto:"Cyber", Pregunta:"Flash Cyber: da un ejemplo de error humano cubierto.", A:"Correcto",B:"Incorrecto",C:"Paso",Resp:"A",Fb:"Acierto:+2 | Error:-1"},
  {Producto:"RC Profesional", Pregunta:"Flash RC: nombra una profesi√≥n excluida.", A:"Correcto",B:"Incorrecto",C:"Paso",Resp:"A",Fb:"Acierto:+2 | Error:-1"},
];

function startTimer(s){ clearInterval(timerId); let t=s; timerEl.textContent=`${t}s`;
  timerId=setInterval(()=>{ t--; timerEl.textContent=`${t}s`; if(t<=0){ clearInterval(timerId); finalizeAnswer(false,"Tiempo agotado.");}},1000);
}
function unlock(){ [optA,optB,optC].forEach(b=>{b.disabled=false;b.classList.remove('correct','wrong')}); qFb.textContent=''; }
function lock(){ [optA,optB,optC].forEach(b=>b.disabled=true); }

document.getElementById('btnOpenQ').onclick=()=>{
  const tm=teams[turn],track=tm.current,pos=tm.pos[track];
  if(CASE_SLOTS.includes(pos+leftToMove)) currentKind='Caso';
  else if(AZAR_SLOTS.includes(pos+leftToMove)) currentKind='Azar';
  else if(INTER_SLOTS.includes(pos+leftToMove)) currentKind='Intersecci√≥n';
  else currentKind='Pregunta';

  selProd.innerHTML='';
  if(currentKind==='Intersecci√≥n'){
    const alt=interPairs[track][pos+leftToMove];
    [track,alt].forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;selProd.appendChild(o);});
  }else{ const o=document.createElement('option');o.value=track;o.textContent=track;selProd.appendChild(o); }
  selProd.onchange=()=>loadQuestion();

  loadQuestion();
  const t=parseInt(document.getElementById('inTimer').value||'45',10); startTimer(t);
  modal.style.display='grid'; answeredOK=null; document.getElementById('btnResolve').disabled=true;
};

function loadQuestion(){
  const tm=teams[turn],track=tm.current,pos=tm.pos[track],target=pos+leftToMove; chosenProduct=selProd.value||track;
  let q;
  if(currentKind==='Caso'){
    const cases=byProduct[chosenProduct].filter(x=>x.Categoria==="Caso");
    q=cases.length?cases[(cur[chosenProduct]++)%cases.length]:nextQ(chosenProduct,true);
    qTitle.textContent=`${chosenProduct} ¬∑ Caso (Casilla ${target})`; qMeta.textContent='Caso (vale doble avance si acierta, -2 si falla)';
  }else if(currentKind==='Azar'){
    const f=flashPool[Math.floor(Math.random()*flashPool.length)]; q={Producto:f.Producto,Categoria:"Flash",Pregunta:f.Pregunta,A:f.A,B:f.B,C:f.C,Resp:f.Resp,Fb:f.Fb}; chosenProduct=f.Producto;
    qTitle.textContent=`AZAR ¬∑ ${chosenProduct} (Casilla ${target})`; qMeta.textContent='Flash de respuesta libre, verificada por el moderador';
  }else if(currentKind==='Intersecci√≥n'){
    q=nextQ(chosenProduct,false); qTitle.textContent=`Intersecci√≥n ¬∑ ${track} ‚Üî ${interPairs[track][target]} (Casilla ${target})`; qMeta.textContent=`Respondiendo por: ${chosenProduct}`;
  }else{
    q=nextQ(chosenProduct,false); qTitle.textContent=`${chosenProduct} ¬∑ Pregunta (Casilla ${target})`; qMeta.textContent=q.Categoria;
  }
  currentQ=q; document.getElementById('qText').textContent=q.Pregunta;
  optA.textContent=`A) ${q.A}`; optB.textContent=`B) ${q.B}`; optC.textContent=`C) ${q.C}`; unlock(); qFb.textContent='';
  postRule.textContent=ruleText(currentKind);
}
function ruleText(kind){
  if(kind==='Caso') return 'Regla: si aciertan, adem√°s del movimiento por dado avanzan +'+leftToMove+' (doble). Si fallan, retroceden 2.';
  if(kind==='Azar') return 'Regla: acierto +2 | error -1 (no aplica dado).';
  if(kind==='Intersecci√≥n') return 'Regla: si aciertan, pueden cambiar de camino. Si fallan, pierden el siguiente turno.';
  return 'Regla: si aciertan, avanzan lo tirado; si fallan, retroceden 1.';
}
function choose(ans){ clearInterval(timerId); const ok=(ans===currentQ.Resp); finalizeAnswer(ok, ok? currentQ.Fb : 'Respuesta incorrecta.'); }
optA.onclick=()=>choose('A'); optB.onclick=()=>choose('B'); optC.onclick=()=>choose('C');
function finalizeAnswer(ok,msg){ qFb.textContent=(ok?'‚úÖ ':'‚ùå ')+msg; lock(); answeredOK=ok; document.getElementById('btnResolve').disabled=false; }

document.getElementById('btnResolve').onclick=()=>{
  const tm=teams[turn],track=tm.current; const pos=tm.pos[track]; const target=Math.min(25,pos+leftToMove);
  if(currentKind==='Azar'){ if(answeredOK){ tm.pos[track]=Math.min(25,pos+2); tm.score+=1; } else { tm.pos[track]=Math.max(1,pos-1); } }
  else if(currentKind==='Caso'){ if(answeredOK){ tm.pos[track]=target; tm.pos[track]=Math.min(25, tm.pos[track]+leftToMove); tm.score+=2; } else { tm.pos[track]=Math.max(1,pos-2); } }
  else if(currentKind==='Intersecci√≥n'){ if(answeredOK){ const alt=interPairs[track][pos+leftToMove]; tm.pos[track]=target; if(confirm(`¬°Correcto! ¬øQuieres cambiar de camino a ${alt}?`)){ tm.current=alt; } tm.score+=1; } else { tm.skip=true; } }
  else { if(answeredOK){ tm.pos[track]=target; tm.score+=1; } else { tm.pos[track]=Math.max(1,pos-1); } }
  if(tm.pos[tm.current]>=25){ alert(`üèÜ ${tm.name} lleg√≥ a la meta en ${tm.current}. ¬°Ganaron!`); }
  renderTokens(); logResult(teams[turn].name, chosenProduct, currentKind, answeredOK, pos, tm.pos[tm.current], lastRoll);
  modal.style.display='none'; document.getElementById('btnResolve').disabled=true; document.getElementById('btnNext').disabled=false;
};

document.getElementById('btnApplyNames').onclick=()=>{
  teams[0].name=document.getElementById('nameA').value||'Equipo A';
  teams[1].name=document.getElementById('nameB').value||'Equipo B';
  teams[2].name=document.getElementById('nameC').value||'Equipo C';
  teams[3].name=document.getElementById('nameD').value||'Equipo D';
  document.getElementById('bA').textContent=teams[0].name; document.getElementById('bB').textContent=teams[1].name;
  document.getElementById('bC').textContent=teams[2].name; document.getElementById('bD').textContent=teams[3].name;
  renderTokens();
};

const results=[];
function logResult(team,product,kind,ok,from,to,roll){ const ts=new Date().toISOString(); results.push({ts,team,product,kind,outcome:ok?'OK':'FAIL',from,to,roll}); }
document.getElementById('btnExport').onclick=()=>{
  const header='timestamp,team,product,kind,outcome,from,to,roll\n';
  const rows=results.map(r=>`${r.ts},${r.team},${r.product},${r.kind},${r.outcome},${r.from},${r.to},${r.roll??''}`).join('\n');
  const blob=new Blob([header+rows],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='jumanji_fl_resultados.csv'; a.click(); URL.revokeObjectURL(url);
};
document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('btnOpenQ').disabled=true; });
</script>
</body>
</html>
